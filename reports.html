<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reports - Clinic Admin</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- htmx (included as requested; not heavily used here but available) -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  <!-- Stimulus (we'll attach a small controller for image preview) -->
  <script src="https://unpkg.com/@hotwired/stimulus/dist/stimulus.umd.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.34.0/dist/supabase.min.js"></script>

  <style>
    /* small safe spacing for sticky headers to avoid overlaps */
    :root { --top-offset: 72px; } 
  </style>
</head>
<body class="bg-gray-50">

  <!-- Header (sticky) -->
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="index.html" class="text-gray-700 hover:text-gray-900 font-semibold">← Main Menu</a>
        <h1 class="text-xl font-bold">Reports</h1>
      </div>
      <div class="text-sm text-gray-600">Admin • Real-time clinic overview</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4" x-data="reportsApp()" x-init="init()" style="padding-top:12px;">

    <!-- Summary cards (sticky under header) -->
    <div class="bg-white p-3 rounded shadow sticky top-[64px] z-40">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="p-3 bg-white rounded border flex flex-col">
          <div class="text-sm text-gray-500">Total Appointments</div>
          <div class="text-2xl font-bold" x-text="stats.totalAppointments">0</div>
        </div>
        <div class="p-3 bg-white rounded border flex flex-col">
          <div class="text-sm text-gray-500">Confirmed</div>
          <div class="text-2xl font-bold text-green-600" x-text="stats.confirmed">0</div>
        </div>
        <div class="p-3 bg-white rounded border flex flex-col">
          <div class="text-sm text-gray-500">Cancelled</div>
          <div class="text-2xl font-bold text-red-600" x-text="stats.cancelled">0</div>
        </div>
        <div class="p-3 bg-white rounded border flex flex-col">
          <div class="text-sm text-gray-500">New Patients</div>
          <div class="text-2xl font-bold text-sky-600" x-text="stats.newPatients">0</div>
        </div>
      </div>
    </div>

    <!-- Tabs: Appointments / Patients / Marketing -->
    <div class="mt-4 bg-white p-3 rounded shadow sticky top-[160px] z-30">
      <div class="flex items-center justify-between">
        <div class="flex space-x-4">
          <button @click="activeSection='appointments'" :class="activeSection==='appointments' ? 'border-b-2 border-blue-500 font-semibold' : ''" class="py-2 px-3">Appointments</button>
          <button @click="activeSection='patients'" :class="activeSection==='patients' ? 'border-b-2 border-blue-500 font-semibold' : ''" class="py-2 px-3">Patients</button>
          <button @click="activeSection='marketing'" :class="activeSection==='marketing' ? 'border-b-2 border-blue-500 font-semibold' : ''" class="py-2 px-3">Marketing / Requests</button>
        </div>

        <!-- Sub-tabs: Today / Week / Month -->
        <div class="flex items-center space-x-2">
          <button @click="period='today'; updateAll()" :class="period==='today' ? 'bg-blue-500 text-white' : 'bg-gray-100' " class="px-3 py-1 rounded">Today</button>
          <button @click="period='week'; updateAll()" :class="period==='week' ? 'bg-blue-500 text-white' : 'bg-gray-100' " class="px-3 py-1 rounded">This Week</button>
          <button @click="period='month'; updateAll()" :class="period==='month' ? 'bg-blue-500 text-white' : 'bg-gray-100' " class="px-3 py-1 rounded">This Month</button>
        </div>
      </div>
    </div>

    <!-- Content area -->
    <div class="mt-4 space-y-6">

      <!-- Appointments view -->
      <section x-show="activeSection==='appointments'">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

          <!-- Charts column -->
          <div class="space-y-4">
            <div class="p-4 bg-white rounded shadow">
              <h3 class="font-semibold mb-2">Appointments Over Time</h3>
              <canvas id="apptsBarChart" class="w-full"></canvas>
            </div>

            <div class="p-4 bg-white rounded shadow">
              <h3 class="font-semibold mb-2">Status Distribution</h3>
              <canvas id="statusPieChart" class="w-full"></canvas>
            </div>
          </div>

          <!-- Table column -->
          <div class="p-4 bg-white rounded shadow">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-semibold">Appointments (details)</h3>
              <div class="text-sm text-gray-600">Showing: <span x-text="period"></span></div>
            </div>

            <div class="overflow-x-auto max-h-[480px] overflow-y-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Patient</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Service</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                    <th class="px-3 py-2 text-xs text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <template x-for="appt in filteredAppointments()" :key="appt.id">
                    <tr>
                      <td class="px-3 py-2 text-sm text-gray-700" x-text="appt.id"></td>
                      <td class="px-3 py-2 text-sm text-gray-700" x-text="appt.patient_name"></td>
                      <td class="px-3 py-2 text-sm text-gray-700" x-text="appt.service"></td>
                      <td class="px-3 py-2 text-sm text-gray-700" x-text="appt.date"></td>
                      <td class="px-3 py-2 text-sm text-gray-700" x-text="appt.time"></td>
                      <td class="px-3 py-2 text-sm font-semibold" :class="{
                          'text-green-600': appt.status==='confirmed',
                          'text-red-600': appt.status==='cancelled',
                          'text-yellow-600': appt.status==='rescheduled',
                          'text-gray-700': appt.status==='new'
                        }" x-text="(appt.status||'').toUpperCase()"></td>
                      <td class="px-3 py-2 text-sm text-gray-700">
                        <div x-text="appt.phone || appt.email || '-'"></div>
                      </td>
                      <td class="px-3 py-2 text-sm">
                        <div class="flex space-x-1">
                          <button @click="confirmAppointment(appt)" class="px-2 py-1 bg-green-500 text-white rounded text-xs" x-show="appt.status!=='confirmed'">Confirm</button>
                          <button @click="reschedulePrompt(appt)" class="px-2 py-1 bg-yellow-400 text-white rounded text-xs">Reschedule</button>
                          <button @click="cancelAppointment(appt)" class="px-2 py-1 bg-red-500 text-white rounded text-xs">Cancel</button>
                        </div>
                      </td>
                    </tr>
                  </template>
                  <tr x-show="filteredAppointments().length===0">
                    <td class="px-3 py-6 text-center text-gray-500" colspan="8">No appointments for this period.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </section>

      <!-- Patients view -->
      <section x-show="activeSection==='patients'">
        <div class="p-4 bg-white rounded shadow">
          <h3 class="font-semibold mb-2">Patients List</h3>
          <div class="overflow-x-auto max-h-[520px] overflow-y-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Last Visit</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Appts</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="p in filteredPatients()" :key="p.id">
                  <tr>
                    <td class="px-3 py-2 text-sm" x-text="p.id"></td>
                    <td class="px-3 py-2 text-sm" x-text="p.full_name"></td>
                    <td class="px-3 py-2 text-sm" x-text="p.phone || '-'"></td>
                    <td class="px-3 py-2 text-sm" x-text="p.email || '-'"></td>
                    <td class="px-3 py-2 text-sm" x-text="p.last_visit || '-'"></td>
                    <td class="px-3 py-2 text-sm" x-text="countAppointmentsForPatient(p.id)"></td>
                  </tr>
                </template>
                <tr x-show="filteredPatients().length===0">
                  <td class="px-3 py-6 text-center text-gray-500" colspan="6">No patients found.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Marketing / Extra services view -->
      <section x-show="activeSection==='marketing'">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- Form -->
          <div class="p-4 bg-white rounded shadow">
            <h3 class="font-semibold mb-2">Log Marketing / New Service Request</h3>
            <input type="text" x-model="marketing.title" placeholder="Title (e.g., 'Whitening Campaign' or 'Patient requested sedation')" class="w-full border px-3 py-2 rounded mb-2"/>
            <textarea x-model="marketing.description" placeholder="Description / notes" class="w-full border px-3 py-2 rounded mb-2"></textarea>
            <input data-action="change->preview#show" type="file" id="marketingImage" class="w-full border px-3 py-2 rounded mb-2" @change="handleMarketingImage($event)"/>
            <div x-show="marketing.preview" class="mb-2">
              <img :src="marketing.preview" class="max-h-40 rounded border"/>
            </div>
            <div class="flex justify-end space-x-2">
              <button @click="clearMarketing()" class="px-3 py-1 border rounded">Clear</button>
              <button @click="submitMarketing()" class="px-3 py-1 bg-blue-500 text-white rounded">Submit</button>
            </div>
          </div>

          <!-- List of marketing logs -->
          <div class="p-4 bg-white rounded shadow">
            <h3 class="font-semibold mb-2">Marketing / Requests</h3>
            <div class="space-y-3 max-h-[520px] overflow-y-auto">
              <template x-for="m in marketingList" :key="m.id">
                <div class="p-3 border rounded">
                  <div class="flex justify-between items-start">
                    <div>
                      <div class="font-semibold" x-text="m.title"></div>
                      <div class="text-sm text-gray-600" x-text="m.description"></div>
                      <div class="text-xs text-gray-400" x-text="new Date(m.created_at).toLocaleString()"></div>
                    </div>
                    <div x-show="m.image_url">
                      <img :src="m.image_url" class="h-16 rounded object-cover"/>
                    </div>
                  </div>
                </div>
              </template>
              <div x-show="marketingList.length===0" class="text-gray-500 italic">No marketing entries yet.</div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

<script>
/* ============================
   Replace with your Supabase details
   ============================ */
const supabase = supabase.createClient('https://YOUR_PROJECT_URL.supabase.co', 'YOUR_ANON_KEY');

/* Chart variables declared globally so Alpine functions can update them */
let apptsBarChart = null;
let statusPieChart = null;

function reportsApp() {
  return {
    activeSection: 'appointments', // appointments | patients | marketing
    period: 'today', // today | week | month

    appointments: [],   // full appointments from supabase
    patients: [],       // full patients
    marketingList: [],

    stats: {
      totalAppointments: 0,
      confirmed: 0,
      cancelled: 0,
      newPatients: 0
    },

    marketing: { title:'', description:'', file:null, preview:null },

    init() {
      // initial load
      this.fetchAll();
      // set up realtime listeners
      this.subscribeRealtime();
      // initialize charts
      this.initCharts();
    },

    /* ----- Fetching ----- */
    async fetchAll() {
      await Promise.all([this.fetchAppointments(), this.fetchPatients(), this.fetchMarketing()]);
      this.updateStats();
      this.updateCharts();
    },

    async fetchAppointments() {
      const { data } = await supabase.from('appointments').select('*').order('date', { ascending: true });
      this.appointments = data || [];
    },

    async fetchPatients() {
      const { data } = await supabase.from('patients').select('*').order('id', { ascending: false });
      this.patients = data || [];
    },

    async fetchMarketing() {
      const { data } = await supabase.from('marketing').select('*').order('created_at', { ascending: false });
      this.marketingList = data || [];
    },

    subscribeRealtime() {
      // appointments
      supabase.from('appointments').on('*', payload => {
        const e = payload.eventType;
        const rec = payload.new || payload.old;
        if(e === 'INSERT') this.appointments.push(payload.new);
        if(e === 'UPDATE') {
          const i = this.appointments.findIndex(a => a.id === payload.new.id);
          if(i !== -1) this.appointments[i] = payload.new;
        }
        if(e === 'DELETE') {
          this.appointments = this.appointments.filter(a => a.id !== payload.old.id);
        }
        this.updateStats();
        this.updateCharts();
      }).subscribe();

      // patients
      supabase.from('patients').on('*', payload => {
        const e = payload.eventType;
        if(e === 'INSERT') this.patients.unshift({...payload.new});
        if(e === 'UPDATE') {
          const i = this.patients.findIndex(p => p.id === payload.new.id);
          if(i !== -1) this.patients[i] = payload.new;
        }
        if(e === 'DELETE') {
          this.patients = this.patients.filter(p => p.id !== payload.old.id);
        }
        this.updateStats();
      }).subscribe();

      // marketing
      supabase.from('marketing').on('*', payload => {
        const e = payload.eventType;
        if(e === 'INSERT') this.marketingList.unshift(payload.new);
        if(e === 'UPDATE') {
          const i = this.marketingList.findIndex(m => m.id === payload.new.id);
          if(i !== -1) this.marketingList[i] = payload.new;
        }
        if(e === 'DELETE') {
          this.marketingList = this.marketingList.filter(m => m.id !== payload.old.id);
        }
      }).subscribe();
    },

    /* ----- Stats ----- */
    updateStats() {
      const appts = this.appointments;
      this.stats.totalAppointments = appts.length;
      this.stats.confirmed = appts.filter(a => a.status === 'confirmed').length;
      this.stats.cancelled = appts.filter(a => a.status === 'cancelled').length;
      this.stats.newPatients = this.patients.filter(p => {
        // new patient within the selected period? for global stat we count all new this month.
        // Here we just count total patients added in last 30 days (approx)
        const created = p.created_at ? new Date(p.created_at) : null;
        if(!created) return false;
        const daysAgo = (Date.now() - created.getTime()) / (1000*60*60*24);
        return daysAgo <= 30;
      }).length;
    },

    /* ----- Filtering helpers ----- */
    filteredAppointments() {
      const now = new Date();
      const start = new Date();
      if(this.period === 'today') {
        start.setHours(0,0,0,0);
      } else if(this.period === 'week') {
        start.setDate(now.getDate() - 7);
        start.setHours(0,0,0,0);
      } else {
        start.setMonth(now.getMonth() - 1);
        start.setHours(0,0,0,0);
      }
      return this.appointments.filter(a => {
        if(!a.date) return false;
        const d = new Date(a.date);
        return d >= start && d <= new Date(now.getTime() + (24*60*60*1000)); // include today
      }).sort((a,b)=> new Date(a.date) - new Date(b.date));
    },

    filteredPatients() {
      // patients with any visit in chosen period OR all patients if you'd like
      return this.patients;
    },

    /* ----- Charts ----- */
    initCharts() {
      // Bar chart
      const barCtx = document.getElementById('apptsBarChart').getContext('2d');
      apptsBarChart = new Chart(barCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Appointments', data: [] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      // Pie chart
      const pieCtx = document.getElementById('statusPieChart').getContext('2d');
      statusPieChart = new Chart(pieCtx, {
        type: 'pie',
        data: { labels: ['Confirmed','Cancelled','Rescheduled','New'], datasets: [{ data: [0,0,0,0] }] },
        options: { responsive: true, maintainAspectRatio: false }
      });

      // initial update
      this.updateCharts();
    },

    updateCharts() {
      // Build timeseries for filteredAppointments grouped by day
      const list = this.filteredAppointments();
      // group by day label
      const map = {};
      list.forEach(a => {
        const d = new Date(a.date);
        const label = d.toLocaleDateString();
        map[label] = (map[label] || 0) + 1;
      });
      const labels = Object.keys(map).sort((a,b)=> new Date(a) - new Date(b));
      const data = labels.map(l => map[l]);

      // update bar chart
      if(apptsBarChart) {
        apptsBarChart.data.labels = labels.length ? labels : ['No data'];
        apptsBarChart.data.datasets[0].data = data.length ? data : [0];
        apptsBarChart.update();
      }

      // update pie chart from filtered appointments statuses
      const statuses = { confirmed:0, cancelled:0, rescheduled:0, new:0 };
      list.forEach(a => statuses[a.status || 'new'] = (statuses[a.status || 'new']||0) + 1);
      if(statusPieChart) {
        statusPieChart.data.datasets[0].data = [statuses.confirmed, statuses.cancelled, statuses.rescheduled, statuses.new];
     
