<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reports - Clinic Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.34.0/dist/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="index.html" class="text-gray-600 hover:text-blue-600 flex items-center">‚Üê Back</a>
      <h1 class="text-xl font-bold text-gray-800">Reports & Analytics</h1>
      <div></div>
    </div>
  </header>

  <!-- Reports Section -->
  <div x-data="reportsApp()" x-init="init()" class="max-w-4xl mx-auto px-4 py-6">

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <h3 class="text-gray-500 text-sm">Total Appointments</h3>
        <p class="text-2xl font-bold text-blue-600" x-text="appointments.length"></p>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <h3 class="text-gray-500 text-sm">Total Patients</h3>
        <p class="text-2xl font-bold text-green-600" x-text="patients.length"></p>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <h3 class="text-gray-500 text-sm">Marketing Requests</h3>
        <p class="text-2xl font-bold text-purple-600" x-text="marketing.length"></p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex border-b mb-6 space-x-6 text-gray-600">
      <button @click="activeTab = 'appointments'" 
              :class="activeTab==='appointments' ? 'text-blue-600 border-b-2 border-blue-600' : ''"
              class="pb-2">Appointments</button>
      <button @click="activeTab = 'patients'" 
              :class="activeTab==='patients' ? 'text-blue-600 border-b-2 border-blue-600' : ''"
              class="pb-2">Patients</button>
      <button @click="activeTab = 'marketing'" 
              :class="activeTab==='marketing' ? 'text-blue-600 border-b-2 border-blue-600' : ''"
              class="pb-2">Marketing</button>
    </div>

    <!-- Appointments Chart -->
    <div x-show="activeTab === 'appointments'" class="space-y-6">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-4">Appointments by Status</h2>
        <canvas id="appointmentsChart"></canvas>
      </div>
    </div>

    <!-- Patients Chart -->
    <div x-show="activeTab === 'patients'" class="space-y-6">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-4">New Patients by Month</h2>
        <canvas id="patientsChart"></canvas>
      </div>
    </div>

    <!-- Marketing Chart -->
    <div x-show="activeTab === 'marketing'" class="space-y-6">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-4">Marketing Requests</h2>
        <canvas id="marketingChart"></canvas>
      </div>
    </div>

  </div>

  <script>
    function reportsApp() {
      return {
        activeTab: 'appointments',
        appointments: [],
        patients: [],
        marketing: [],
        charts: {},

        async init() {
          const client = supabase.createClient(
            "https://YOUR_PROJECT_URL.supabase.co",
            "YOUR_ANON_KEY"
          );

          // Load initial data
          let { data: appts } = await client.from('appointments').select('*');
          this.appointments = appts || [];

          let { data: pats } = await client.from('patients').select('*');
          this.patients = pats || [];

          let { data: marketing } = await client.from('marketing').select('*');
          this.marketing = marketing || [];

          this.renderCharts();

          // Realtime
          client.channel('appointments')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, p => {
              this.handleRealtimeChange(this.appointments, p);
              this.renderAppointmentsChart();
            }).subscribe();

          client.channel('patients')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'patients' }, p => {
              this.handleRealtimeChange(this.patients, p);
              this.renderPatientsChart();
            }).subscribe();

          client.channel('marketing')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'marketing' }, p => {
              this.handleRealtimeChange(this.marketing, p);
              this.renderMarketingChart();
            }).subscribe();
        },

        handleRealtimeChange(list, payload) {
          if (payload.eventType === 'INSERT') {
            list.push(payload.new);
          } else if (payload.eventType === 'UPDATE') {
            const idx = list.findIndex(i => i.id === payload.new.id);
            if (idx !== -1) list[idx] = payload.new;
          } else if (payload.eventType === 'DELETE') {
            const idx = list.findIndex(i => i.id === payload.old.id);
            if (idx !== -1) list.splice(idx, 1);
          }
        },

        renderCharts() {
          this.renderAppointmentsChart();
          this.renderPatientsChart();
          this.renderMarketingChart();
        },

        renderAppointmentsChart() {
          const ctx = document.getElementById('appointmentsChart');
          if (!ctx) return;
          const statusCounts = this.appointments.reduce((acc, appt) => {
            acc[appt.status] = (acc[appt.status] || 0) + 1;
            return acc;
          }, {});
          this.updateChart('appointments', ctx, 'pie', Object.keys(statusCounts), Object.values(statusCounts));
        },

        renderPatientsChart() {
          const ctx = document.getElementById('patientsChart');
          if (!ctx) return;
          // group by month
          const monthly = this.patients.reduce((acc, p) => {
            const month = new Date(p.created_at).toLocaleString('default', { month: 'short' });
            acc[month] = (acc[month] || 0) + 1;
            return acc;
          }, {});
          this.updateChart('patients', ctx, 'bar', Object.keys(monthly), Object.values(monthly));
        },

        renderMarketingChart() {
          const ctx = document.getElementById('marketingChart');
          if (!ctx) return;
          const counts = this.marketing.reduce((acc, m) => {
            acc[m.type] = (acc[m.type] || 0) + 1;
            return acc;
          }, {});
          this.updateChart('marketing', ctx, 'doughnut', Object.keys(counts), Object.values(counts));
        },

        updateChart(key, ctx, type, labels, values) {
          if (this.charts[key]) this.charts[key].destroy();
          this.charts[key] = new Chart(ctx, {
            type,
            data: {
              labels,
              datasets: [{
                data: values,
                backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6']
              }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        }
      }
    }
  </script>
</body>
</html>
