<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reports - Clinic Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.34.0/dist/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="index.html" class="text-gray-600 hover:text-blue-600 flex items-center">
        ‚Üê Back
      </a>
      <h1 class="text-2xl font-bold text-gray-800">Reports & Analytics</h1>
      <div></div>
    </div>
  </header>

  <!-- Reports Section -->
  <div x-data="reportsApp()" x-init="init()" class="max-w-6xl mx-auto px-4 py-6">

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-gray-500 text-sm">Total Appointments</h3>
        <p class="text-2xl font-bold text-blue-600" x-text="appointments.length"></p>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-gray-500 text-sm">Total Patients</h3>
        <p class="text-2xl font-bold text-green-600" x-text="patients.length"></p>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-gray-500 text-sm">Marketing Requests</h3>
        <p class="text-2xl font-bold text-purple-600" x-text="marketing.length"></p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex border-b mb-6 space-x-6 text-gray-600">
      <button @click="activeTab = 'appointments'" 
              :class="activeTab==='appointments' ? 'text-blue-600 border-b-2 border-blue-600' : ''"
              class="pb-2">Appointments</button>
      <button @click="activeTab = 'patients'" 
              :class="activeTab==='patients' ? 'text-blue-600 border-b-2 border-blue-600' : ''"
              class="pb-2">Patients</button>
      <button @click="activeTab = 'marketing'" 
              :class="activeTab==='marketing' ? 'text-blue-600 border-b-2 border-blue-600' : ''"
              class="pb-2">Marketing</button>
    </div>

    <!-- Appointments Report -->
    <div x-show="activeTab === 'appointments'" class="space-y-6">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-4">Appointments by Status</h2>
        <canvas id="appointmentsChart"></canvas>
      </div>
    </div>

    <!-- Patients Report -->
    <div x-show="activeTab === 'patients'" class="space-y-6">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-4">Patients Overview</h2>
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-50 text-gray-600 text-left">
              <th class="py-2 px-3">ID</th>
              <th class="py-2 px-3">Full Name</th>
              <th class="py-2 px-3">Phone</th>
              <th class="py-2 px-3">Email</th>
              <th class="py-2 px-3">Services Taken</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="p in patients" :key="p.id">
              <tr class="border-t">
                <td class="py-2 px-3" x-text="p.id"></td>
                <td class="py-2 px-3" x-text="p.full_name"></td>
                <td class="py-2 px-3" x-text="p.phone"></td>
                <td class="py-2 px-3" x-text="p.email"></td>
                <td class="py-2 px-3" x-text="countAppointmentsForPatient(p.id)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Marketing Report -->
    <div x-show="activeTab === 'marketing'" class="space-y-6">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-4">Marketing Requests</h2>
        <ul class="divide-y">
          <template x-for="m in marketing" :key="m.id">
            <li class="py-3">
              <p class="font-medium text-gray-800" x-text="m.title"></p>
              <p class="text-sm text-gray-600" x-text="m.description"></p>
            </li>
          </template>
        </ul>
      </div>
    </div>
  </div>

  <script>
    function reportsApp() {
      return {
        activeTab: 'appointments',
        appointments: [],
        patients: [],
        marketing: [],
        chart: null,

        async init() {
          const client = supabase.createClient(
            "https://YOUR_PROJECT_URL.supabase.co",
            "YOUR_ANON_KEY"
          );

          // Load initial data
          let { data: appts } = await client.from('appointments').select('*');
          this.appointments = appts || [];

          let { data: pats } = await client.from('patients').select('*');
          this.patients = pats || [];

          let { data: marketing } = await client.from('marketing').select('*');
          this.marketing = marketing || [];

          this.renderAppointmentsChart();

          // Realtime listeners
          client.channel('appointments')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, payload => {
              this.handleRealtimeChange(this.appointments, payload);
              this.renderAppointmentsChart();
            }).subscribe();

          client.channel('patients')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'patients' }, payload => {
              this.handleRealtimeChange(this.patients, payload);
            }).subscribe();

          client.channel('marketing')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'marketing' }, payload => {
              this.handleRealtimeChange(this.marketing, payload);
            }).subscribe();
        },

        handleRealtimeChange(list, payload) {
          if (payload.eventType === 'INSERT') {
            list.push(payload.new);
          } else if (payload.eventType === 'UPDATE') {
            const idx = list.findIndex(i => i.id === payload.new.id);
            if (idx !== -1) list[idx] = payload.new;
          } else if (payload.eventType === 'DELETE') {
            const idx = list.findIndex(i => i.id === payload.old.id);
            if (idx !== -1) list.splice(idx, 1);
          }
        },

        countAppointmentsForPatient(pid) {
          return this.appointments.filter(a => a.patient_id === pid).length;
        },

        renderAppointmentsChart() {
          const ctx = document.getElementById('appointmentsChart').getContext('2d');
          const statusCounts = this.appointments.reduce((acc, appt) => {
            acc[appt.status] = (acc[appt.status] || 0) + 1;
            return acc;
          }, {});

          const labels = Object.keys(statusCounts);
          const values = Object.values(statusCounts);

          if (this.chart) this.chart.destroy();

          this.chart = new Chart(ctx, {
            type: 'pie',
            data: {
              labels,
              datasets: [{
                data: values,
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444']
              }]
            }
          });
        }
      }
    }
  </script>
</body>
</html>
