<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yanet Dental Clinic - Services Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.34.0/dist/supabase.min.js"></script>
</head>
<body class="bg-gray-50">

  <!-- Top Navbar with Back Arrow -->
  <nav class="bg-white shadow p-3 flex items-center space-x-4">
    <a href="dashboard.html" class="text-gray-700 font-semibold hover:text-gray-900">‚Üê Back</a>
    <h1 class="text-lg font-bold">Services Admin</h1>
  </nav>

  <div class="max-w-4xl mx-auto p-4" x-data="servicesSection()" x-init="init()">

    <!-- Tabs -->
    <div class="flex space-x-4 border-b border-gray-200 mb-4">
      <button @click="activeTab='tips'" 
              :class="activeTab==='tips' ? 'border-b-2 border-blue-500 font-semibold' : ''"
              class="py-2 px-4">Dental Tips</button>
      <button @click="activeTab='news'" 
              :class="activeTab==='news' ? 'border-b-2 border-blue-500 font-semibold' : ''"
              class="py-2 px-4">Clinic News</button>
      <button @click="activeTab='reviews'" 
              :class="activeTab==='reviews' ? 'border-b-2 border-blue-500 font-semibold' : ''"
              class="py-2 px-4">Before & After</button>
    </div>

    <!-- Dental Tips Form -->
    <div x-show="activeTab==='tips'" class="space-y-4">
      <h2 class="font-bold text-lg">Add Dental Tip</h2>
      <textarea x-model="newTip.description" placeholder="Description" class="w-full border px-2 py-1 rounded"></textarea>
      <input type="file" @change="uploadImage($event, 'tips')" class="border px-2 py-1 rounded w-full"/>
      <button @click="addTip()" class="px-4 py-2 bg-blue-500 text-white rounded shadow">Submit Tip</button>

      <!-- List of Dental Tips -->
      <div class="mt-6 space-y-4">
        <template x-for="tip in tips" :key="tip.id">
          <div class="p-3 border rounded bg-white shadow">
            <p class="text-gray-800" x-text="tip.description"></p>
            <img x-show="tip.image_url" :src="tip.image_url" class="mt-2 w-full max-h-60 object-cover rounded"/>
          </div>
        </template>
      </div>
    </div>

    <!-- Clinic News Form -->
    <div x-show="activeTab==='news'" class="space-y-4">
      <h2 class="font-bold text-lg">Add Clinic News</h2>
      <textarea x-model="newNews.description" placeholder="Description" class="w-full border px-2 py-1 rounded"></textarea>
      <input type="file" @change="uploadImage($event, 'news')" class="border px-2 py-1 rounded w-full"/>
      <button @click="addNews()" class="px-4 py-2 bg-blue-500 text-white rounded shadow">Submit News</button>

      <!-- List of Clinic News -->
      <div class="mt-6 space-y-4">
        <template x-for="newsItem in news" :key="newsItem.id">
          <div class="p-3 border rounded bg-white shadow">
            <p class="text-gray-800" x-text="newsItem.description"></p>
            <img x-show="newsItem.image_url" :src="newsItem.image_url" class="mt-2 w-full max-h-60 object-cover rounded"/>
          </div>
        </template>
      </div>
    </div>

    <!-- Before & After Form -->
    <div x-show="activeTab==='reviews'" class="space-y-4">
      <template x-for="(review, index) in reviews" :key="index">
        <div class="p-3 border rounded bg-white shadow space-y-2">
          <h3 class="font-semibold">Customer {{ index+1 }}</h3>
          <div class="flex gap-2">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700">Before Image</label>
              <input type="file" @change="uploadReviewImage($event, index+1, 'before')" class="border px-2 py-1 rounded w-full"/>
              <img x-show="review.before_image_url" :src="review.before_image_url" class="mt-1 w-full h-24 object-cover rounded"/>
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700">After Image</label>
              <input type="file" @change="uploadReviewImage($event, index+1, 'after')" class="border px-2 py-1 rounded w-full"/>
              <img x-show="review.after_image_url" :src="review.after_image_url" class="mt-1 w-full h-24 object-cover rounded"/>
            </div>
          </div>
          <textarea x-model="review.comment" placeholder="Comment" class="w-full border px-2 py-1 rounded"></textarea>
          <button @click="addOrUpdateReview(index+1)" class="px-3 py-1 bg-green-500 text-white rounded shadow">Save</button>
        </div>
      </template>
    </div>

  </div>

  <script>
    // Supabase client setup
    const supabase = supabase.createClient('https://YOUR_PROJECT_URL.supabase.co', 'YOUR_ANON_KEY');

    function servicesSection() {
      return {
        activeTab: 'tips',
        tips: [],
        news: [],
        reviews: Array(9).fill({ before_image_url: '', after_image_url: '', comment: '' }),
        newTip: { description:'', image_url:'' },
        newNews: { description:'', image_url:'' },

        async init() {
          await this.fetchTips();
          await this.fetchNews();
          await this.fetchReviews();

          // Real-time subscriptions
          supabase.channel('realtime-tips')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'dental_tips' }, payload => {
              this.tips.unshift(payload.new);
            }).subscribe();

          supabase.channel('realtime-news')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'clinic_news' }, payload => {
              this.news.unshift(payload.new);
            }).subscribe();

          supabase.channel('realtime-reviews')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'before_after_reviews' }, payload => {
              const updatedRow = payload.new;
              if(updatedRow && updatedRow.id) this.reviews[updatedRow.id-1] = updatedRow;
            }).subscribe();
        },

        async fetchTips() {
          const { data, error } = await supabase.from('dental_tips').select('*').order('created_at', { ascending: false });
          if (error) return console.error(error);
          this.tips = data || [];
        },

        async fetchNews() {
          const { data, error } = await supabase.from('clinic_news').select('*').order('created_at', { ascending: false });
          if (error) return console.error(error);
          this.news = data || [];
        },

        async fetchReviews() {
          const { data, error } = await supabase.from('before_after_reviews').select('*').order('id', { ascending: true });
          if(error) return console.error(error);
          if(data) this.reviews = data;
        },

        async addTip() {
          if(!this.newTip.description) return alert("Enter description");
          const { data, error } = await supabase.from('dental_tips').insert([this.newTip]).select();
          if(error) return alert(error.message);
          this.newTip = { description:'', image_url:'' };
        },

        async addNews() {
          if(!this.newNews.description) return alert("Enter description");
          const { data, error } = await supabase.from('clinic_news').insert([this.newNews]).select();
          if(error) return alert(error.message);
          this.newNews = { description:'', image_url:'' };
        },

        async uploadImage(event, type) {
          const file = event.target.files[0];
          if(!file) return;
          const fileExt = file.name.split('.').pop();
          const fileName = `${Math.random()}.${fileExt}`;
          const { data, error } = await supabase.storage.from('images').upload(fileName, file);
          if(error) return alert(error.message);
          const url = supabase.storage.from('images').getPublicUrl(fileName).publicUrl;
          if(type==='tips') this.newTip.image_url = url;
          if(type==='news') this.newNews.image_url = url;
        },

        async uploadReviewImage(event, index, type) {
          const file = event.target.files[0];
          if(!file) return;
          const fileExt = file.name.split('.').pop();
          const fileName = `review_${index}_${type}.${fileExt}`;
          const { error } = await supabase.storage.from('images').upload(fileName, file, { upsert: true });
          if(error) return alert(error.message);
          const url = supabase.storage.from('images').getPublicUrl(fileName).publicUrl;
          this.reviews[index-1][type + '_image_url'] = url;
        },

        async addOrUpdateReview(index) {
          const review = this.reviews[index-1];
          if(!review.before_image_url || !review.after_image_url || !review.comment) 
            return alert("Please fill all fields");

          const { data: existing, error: selectError } = await supabase
            .from('before_after_reviews')
            .select('*')
            .eq('id', index);
          if(selectError) return alert(selectError.message);

          if(existing.length > 0) {
            const { error: updateError } = await supabase
              .from('before_after_reviews')
              .update({
                before_image_url: review.before_image_url,
                after_image_url: review.after_image_url,
                comment: review.comment
              })
              .eq('id', index);
            if(updateError) return alert(updateError.message);
          } else {
            const { error: insertError } = await supabase
              .from('before_after_reviews')
              .insert([{ id: index, ...review }]);
            if(insertError) return alert(insertError.message);
          }
          alert("Review submitted successfully!");
        }
      }
    }
  </script>

</body>
</html>
