<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Settings</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://unpkg.com/@hotwired/stimulus/dist/stimulus.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
<div class="container mx-auto px-4 py-8 max-w-4xl">
<h1 class="text-3xl font-bold text-gray-900 mb-8">Admin Settings</h1>

<!-- Profile & Security Card -->
<div class="bg-white rounded-lg shadow-md mb-6" x-data="{ open: true }">
<div class="p-6 border-b border-gray-200">
<button @click="open = !open" class="flex items-center justify-between w-full text-left">
<h2 class="text-xl font-semibold text-gray-900">Profile & Security</h2>
<i class="fas fa-chevron-down transition-transform duration-200" :class="{ 'rotate-180': open }"></i>
</button>
</div>
<div x-show="open" x-transition class="p-6">
<form data-controller="profile" data-action="submit->profile#updateProfile">
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<!-- Profile Picture -->
<div class="md:col-span-2">
<label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture</label>
<div class="flex items-center space-x-4">
<img id="profileImage" src="https://via.placeholder.com/80" alt="Profile" class="w-20 h-20 rounded-full object-cover border-2 border-gray-300">
<div>
<input type="file" id="profilePicture" accept="image/*" class="hidden" data-profile-target="fileInput">
<button type="button" onclick="document.getElementById('profilePicture').click()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
<i class="fas fa-camera mr-2"></i>Change Photo
</button>
</div>
</div>
</div>

<!-- Email -->
<div>
<label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
<input type="email" id="email" name="email" data-profile-target="email" 
class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
value="admin@company.com">
</div>

<!-- Phone -->
<div>
<label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
<input type="tel" id="phone" name="phone" data-profile-target="phone"
class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
value="+251">
</div>

<!-- Password -->
<div>
<label for="password" class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
<input type="password" id="password" name="password" data-profile-target="password"
class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
placeholder="Enter new password">
</div>

<!-- Confirm Password -->
<div>
<label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
<input type="password" id="confirmPassword" name="confirmPassword" data-profile-target="confirmPassword"
class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
placeholder="Confirm new password">
</div>
</div>

<div class="mt-6">
<button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition">
<i class="fas fa-save mr-2"></i>Save Changes
</button>
</div>
</form>
</div>
</div>

<!-- User Management Card -->
<div class="bg-white rounded-lg shadow-md mb-6" x-data="{ open: true, showAddForm: false }">
<div class="p-6 border-b border-gray-200">
<button @click="open = !open" class="flex items-center justify-between w-full text-left">
<h2 class="text-xl font-semibold text-gray-900">User Management</h2>
<i class="fas fa-chevron-down transition-transform duration-200" :class="{ 'rotate-180': open }"></i>
</button>
</div>
<div x-show="open" x-transition class="p-6">
<!-- Add New Staff Button -->
<div class="mb-6">
<button @click="showAddForm = !showAddForm" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
<i class="fas fa-plus mr-2"></i>Add New Staff
</button>
</div>

<!-- Add Staff Form -->
<div x-show="showAddForm" x-transition class="bg-gray-50 p-4 rounded-lg mb-6">
<form data-controller="staff" data-action="submit->staff#addStaff">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
<input type="text" name="fullName" data-staff-target="fullName" required
class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
<input type="email" name="email" data-staff-target="email" required
class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
<input type="tel" name="phone" data-staff-target="phone" required
class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
value="+251">
</div>
</div>
<div class="mt-4 flex space-x-2">
<button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">
<i class="fas fa-save mr-1"></i>Save
</button>
<button type="button" @click="showAddForm = false" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
Cancel
</button>
</div>
</form>
</div>

<!-- Staff Table -->
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
</tr>
</thead>
<tbody id="staffTableBody" class="bg-white divide-y divide-gray-200">
<!-- Staff rows populated by JS -->
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Toast Notifications -->
<div id="toast-container" class="fixed top-4 right-4 z-50"></div>

<script>
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const Utils = {
showToast(msg,type='success'){const t=document.createElement('div');t.className=`p-4 rounded-md shadow-lg mb-2 transition-all duration-300 ${type==='success'?'bg-green-500 text-white':type==='error'?'bg-red-500 text-white':'bg-blue-500 text-white'}`;t.innerHTML=`<div class="flex items-center justify-between"><span>${msg}</span><button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200"><i class="fas fa-times"></i></button></div>`;document.getElementById('toast-container').appendChild(t);setTimeout(()=>{if(t.parentElement)t.remove();},5000)},
validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);},validatePhone(p){return/^\+251[0-9]{9,12}$/.test(p.replace(/[\s\-\(\)]/g,''));},
validatePassword(p){return p.length>=8;}
};

// Stimulus Controllers
const { Application, Controller } = Stimulus;
const application = Application.start();

// Profile Controller
class ProfileController extends Controller {
static targets = ["email","phone","password","confirmPassword","fileInput"];
connect(){this.loadProfile();this.fileInputTarget.addEventListener('change',this.handleFileUpload.bind(this));}
async loadProfile(){try{const {data,error}=await supabase.from('users').select('*').eq('role','admin').single();if(error)throw error;if(data){this.emailTarget.value=data.email||'';this.phoneTarget.value=data.phone||'+251';if(data.profile_picture){document.getElementById('profileImage').src=data.profile_picture;}}}catch(e){console.error(e);}}
async handleFileUpload(event){const file=event.target.files[0];if(!file)return;if(!file.type.startsWith('image/')){Utils.showToast('Please select a valid image file','error');return;}if(file.size>5*1024*1024){Utils.showToast('File size must be less than 5MB','error');return;}try{const fileName=`profile_${Date.now()}.${file.name.split('.').pop()}`;const {data,error}=await supabase.storage.from('profiles').upload(fileName,file);if(error)throw error;const {data:{publicUrl}}=supabase.storage.from('profiles').getPublicUrl(fileName);document.getElementById('profileImage').src=publicUrl;await supabase.from('users').update({profile_picture:publicUrl}).eq('role','admin');Utils.showToast('Profile picture updated successfully');}catch(e){console.error(e);Utils.showToast('Error uploading file','error');}}
async updateProfile(e){e.preventDefault();const email=this.emailTarget.value;const phone=this.phoneTarget.value;const password=this.passwordTarget.value;const confirmPassword=this.confirmPasswordTarget.value;if(!Utils.validateEmail(email)){Utils.showToast('Please enter a valid email','error');return;}if(phone&&!Utils.validatePhone(phone)){Utils.showToast('Phone must start with +251','error');return;}if(password&&password!==confirmPassword){Utils.showToast('Passwords do not match','error');return;}try{const updates={email,phone};if(password)updates.password=password;await supabase.from('users').update(updates).eq('role','admin');Utils.showToast('Profile updated successfully');}catch(e){console.error(e);Utils.showToast('Error updating profile','error');}}
}
application.register("profile",ProfileController);

// Staff Controller
class StaffController extends Controller {
static targets=["fullName","email","phone"];
connect(){this.loadStaff();}
async loadStaff(){try{const {data,error}=await supabase.from('users').select('*').neq('role','admin');if(error)throw error;const tbody=document.getElementById('staffTableBody');tbody.innerHTML='';data.forEach(staff=>{const tr=document.createElement('tr');tr.innerHTML=`<td class="px-6 py-4 whitespace-nowrap"><span class="staff-name">${staff.fullName}</span></td><td class="px-6 py-4 whitespace-nowrap"><span class="staff-email">${staff.email}</span></td><td class="px-6 py-4 whitespace-nowrap"><span class="staff-phone">${staff.phone}</span></td><td class="px-6 py-4 whitespace-nowrap space-x-2"><button class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600" onclick="editStaff('${staff.id}',this)">Edit</button><button class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700" onclick="deleteStaff('${staff.id}')">Delete</button></td>`;tbody.appendChild(tr);});}catch(e){console.error(e);}}
async addStaff(e){e.preventDefault();const fullName=this.fullNameTarget.value;const email=this.emailTarget.value;const phone=this.phoneTarget.value;if(!fullName||!email||!phone){Utils.showToast('All fields required','error');return;}if(!Utils.validateEmail(email)){Utils.showToast('Invalid email','error');return;}if(!Utils.validatePhone(phone)){Utils.showToast('Phone must start with +251','error');return;}try{await supabase.from('users').insert({fullName,email,phone,role:'staff'});Utils.showToast('Staff added');this.fullNameTarget.value='';this.emailTarget.value='';this.phoneTarget.value='+251';this.loadStaff();}catch(e){console.error(e);Utils.showToast('Error adding staff','error');}}
}
application.register("staff",StaffController);

// Inline Edit Functions
window.editStaff=async function(id,btn){const tr=btn.closest('tr');const nameSpan=tr.querySelector('.staff-name');const emailSpan=tr.querySelector('.staff-email');const phoneSpan=tr.querySelector('.staff-phone');const currentName=nameSpan.textContent;const currentEmail=emailSpan.textContent;const currentPhone=phoneSpan.textContent;nameSpan.innerHTML=`<input class="w-full px-2 py-1 border rounded" value="${currentName}">`;emailSpan.innerHTML=`<input class="w-full px-2 py-1 border rounded" value="${currentEmail}">`;phoneSpan.innerHTML=`<input class="w-full px-2 py-1 border rounded" value="${currentPhone}">`;btn.textContent='Save';btn.onclick=async()=>{const newName=nameSpan.querySelector('input').value;const newEmail=emailSpan.querySelector('input').value;const newPhone=phoneSpan.querySelector('input').value;if(!Utils.validateEmail(newEmail)){Utils.showToast('Invalid email','error');return;}if(!Utils.validatePhone(newPhone)){Utils.showToast('Phone must start with +251','error');return;}try{await supabase.from('users').update({fullName:newName,email:newEmail,phone:newPhone}).eq('id',id);Utils.showToast('Staff updated');nameSpan.textContent=newName;emailSpan.textContent=newEmail;phoneSpan.textContent=newPhone;btn.textContent='Edit';btn.onclick=()=>editStaff(id,btn);}catch(e){console.error(e);Utils.showToast('Error updating','error');}};}
window.deleteStaff=async function(id){if(!confirm('Delete this staff?'))return;try{await supabase.from('users').delete().eq('id',id);Utils.showToast('Staff deleted');document.getElementById('staffTableBody').querySelector(`tr`).remove();}catch(e){console.error(e);Utils.showToast('Error deleting','error');}}
</script>
</body>
</html>
