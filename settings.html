<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://unpkg.com/htmx.org@1.9.5"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabaseUrl = 'YOUR_SUPABASE_URL';
    const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
    window.supabase = createClient(supabaseUrl, supabaseKey);

    // --- Profile & Security ---
    window.saveProfile = async () => {
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const password = document.getElementById('password').value;
      const profilePic = document.getElementById('profile-pic').files[0];
      const userId = 'ADMIN_USER_ID'; // Replace with your admin ID

      let updates = { email, phone };
      if(password) updates.password = password;

      // Upload profile picture if selected
      if(profilePic){
        const { data, error: uploadError } = await supabase.storage
          .from('profile-pics')
          .upload(`public/${userId}/${profilePic.name}`, profilePic, { upsert: true });
        if(uploadError) return alert('Error uploading image: '+uploadError.message);

        const { data: urlData } = supabase.storage.from('profile-pics').getPublicUrl(`public/${userId}/${profilePic.name}`);
        updates.profile_picture = urlData.publicUrl;
      }

      const { error } = await supabase.from('users').update(updates).eq('id', userId);
      if(error) alert('Error: '+error.message);
      else alert('Profile updated!');
    }

    // --- User Management ---
    async function loadStaff() {
      const { data, error } = await supabase.from('staff').select('*').order('id',{ascending:true});
      const tbody = document.getElementById('staff-list');
      tbody.innerHTML = '';
      if(error) return alert('Error loading staff: '+error.message);

      data.forEach(staff => {
        const row = document.createElement('tr');
        row.classList.add('border-b');
        row.innerHTML = `
          <td class="px-2 py-1"><input type="text" value="${staff.full_name}" class="w-full border p-1 rounded" data-id="${staff.id}" data-field="full_name"></td>
          <td class="px-2 py-1"><input type="email" value="${staff.email}" class="w-full border p-1 rounded" data-id="${staff.id}" data-field="email"></td>
          <td class="px-2 py-1"><input type="text" value="${staff.phone || ''}" class="w-full border p-1 rounded" data-id="${staff.id}" data-field="phone"></td>
          <td class="px-2 py-1"><input type="text" value="${staff.role || ''}" class="w-full border p-1 rounded" data-id="${staff.id}" data-field="role"></td>
          <td class="px-2 py-1 space-x-2">
            <button onclick="updateStaff(${staff.id})" class="px-2 py-1 bg-yellow-500 text-white rounded">Save</button>
            <button onclick="deleteStaff(${staff.id})" class="px-2 py-1 bg-red-600 text-white rounded">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    window.addStaff = async () => {
      const name = prompt("Full Name:");
      const email = prompt("Email:");
      const phone = prompt("Phone:");
      const role = prompt("Role:");
      if(!name || !email) return alert("Name and Email required");
      const { error } = await supabase.from('staff').insert([{ full_name:name,email,phone,role }]);
      if(error) alert('Error adding staff: '+error.message);
      else { alert('Staff added!'); loadStaff(); }
    }

    window.updateStaff = async (id) => {
      const row = document.querySelectorAll(`input[data-id='${id}']`);
      const updates = {};
      row.forEach(input => updates[input.dataset.field] = input.value);
      const { error } = await supabase.from('staff').update(updates).eq('id', id);
      if(error) alert('Error updating: '+error.message);
      else alert('Staff updated!');
    }

    window.deleteStaff = async (id) => {
      if(!confirm("Delete this staff?")) return;
      const { error } = await supabase.from('staff').delete().eq('id', id);
      if(error) alert('Error deleting: '+error.message);
      else loadStaff();
    }

    // --- Appointment Configuration ---
    window.saveAppointment = async () => {
      const duration = document.getElementById('appointment-duration').value;
      const hours = document.getElementById('opening-hours').value;
      const buffer = document.getElementById('buffer-time').value;
      const { error } = await supabase.from('settings').update({appointment_duration:duration,opening_hours:hours,buffer_time:buffer}).eq('id',1);
      if(error) alert('Error saving appointment: '+error.message);
      else alert('Appointment saved!');
    }

    // --- System Preferences ---
    window.savePreferences = async () => {
      const currency = document.getElementById('currency').value;
      const timezone = document.getElementById('timezone').value;
      const notifications = document.getElementById('notifications').checked;
      const { error } = await supabase.from('settings').update({currency,timezone,notifications}).eq('id',1);
      if(error) alert('Error saving preferences: '+error.message);
      else alert('Preferences saved!');
    }

    document.addEventListener('DOMContentLoaded', loadStaff);
  </script>
</head>
<body class="bg-gray-50 min-h-screen p-4">

<div class="max-w-4xl mx-auto space-y-4">

  <!-- Profile & Security -->
  <div x-data="{ open:true, twoFA:false }" class="border rounded shadow bg-white">
    <button @click="open=!open" class="w-full text-left px-4 py-2 bg-blue-600 text-white font-semibold rounded-t">Profile & Security</button>
    <div x-show="open" class="p-4 space-y-3">
      <div><label>Email</label><input id="email" type="email" class="w-full border p-2 rounded" placeholder="Email"></div>
      <div><label>Phone</label><input id="phone" type="tel" class="w-full border p-2 rounded" placeholder="Phone"></div>
      <div><label>Password</label><input id="password" type="password" class="w-full border p-2 rounded" placeholder="New Password"></div>
      <div>
        <label class="flex items-center"><input type="checkbox" x-model="twoFA" class="form-checkbox"><span class="ml-2">Enable 2FA</span></label>
        <div x-show="twoFA" class="mt-2 space-y-2">
          <img src="qr-code-placeholder.png" alt="QR" class="w-32 h-32 border rounded">
          <input type="text" class="w-full border p-2 rounded" placeholder="OTP">
        </div>
      </div>
      <div>
        <label>Profile Picture</label>
        <input id="profile-pic" type="file" class="w-full border p-2 rounded">
      </div>
      <button onclick="saveProfile()" class="px-4 py-2 bg-blue-600 text-white rounded">Save Profile</button>
    </div>
  </div>

  <!-- User Management -->
  <div x-data="{ open:false }" class="border rounded shadow bg-white">
    <button @click="open=!open" class="w-full text-left px-4 py-2 bg-blue-600 text-white font-semibold rounded-t">User Management</button>
    <div x-show="open" class="p-4 space-y-3">
      <button onclick="addStaff()" class="px-4 py-2 bg-green-600 text-white rounded">+ Add Staff</button>
      <table class="w-full text-left border mt-2">
        <thead class="bg-gray-100">
          <tr><th class="px-2 py-1">Full Name</th><th class="px-2 py-1">Email</th><th class="px-2 py-1">Phone</th><th class="px-2 py-1">Role</th><th class="px-2 py-1">Actions</th></tr>
        </thead>
        <tbody id="staff-list"></tbody>
      </table>
    </div>
  </div>

  <!-- Appointment Configuration -->
  <div x-data="{ open:false }" class="border rounded shadow bg-white">
    <button @click="open=!open" class="w-full text-left px-4 py-2 bg-blue-600 text-white font-semibold rounded-t">Appointment Configuration</button>
    <div x-show="open" class="p-4 space-y-3">
      <div>
        <label>Appointment Duration</label>
        <select id="appointment-duration" class="w-full border p-2 rounded">
          <option>15 min</option>
          <option>30 min</option>
          <option>45 min</option>
          <option>60 min</option>
        </select>
      </div>
      <div>
        <label>Opening Hours</label>
        <input id="opening-hours" type="text" class="w-full border p-2 rounded" placeholder="9:00 AM - 5:00 PM">
      </div>
      <div>
        <label>Buffer Time (min)</label>
        <input id="buffer-time" type="number" class="w-full border p-2 rounded" placeholder="10">
      </div>
      <button onclick="saveAppointment()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
    </div>
  </div>

  <!-- System Preferences -->
  <div x-data="{ open:false }" class="border rounded shadow bg-white">
    <button @click="open=!open" class="w-full text-left px-4 py-2 bg-blue-600 text-white font-semibold rounded-t">System Preferences</button>
    <div x-show="open" class="p-4 space-y-3">
      <div>
        <label>Currency</label>
        <select id="currency" class="w-full border p-2 rounded">
          <option>USD</option>
          <option>ETB</option>
          <option>EUR</option>
        </select>
      </div>
      <div>
        <label>Timezone</label>
        <select id="timezone" class="w-full border p-2 rounded">
          <option>Africa/Addis_Ababa</option>
          <option>UTC</option>
          <option>America/New_York</option>
        </select>
      </div>
      <div class="flex items-center">
        <input id="notifications" type="checkbox" class="form-checkbox">
        <label class="ml-2">Enable Notifications</label>
      </div>
      <button onclick="savePreferences()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
    </div>
  </div>

</div>

</body>
</html>
