<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patients - Yanet Dental Clinic</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100">

  <div class="p-6" x-data="patientsSection()" x-init="init()">

    <!-- Page Title -->
    <h1 class="text-2xl font-bold mb-4">Patients</h1>

    <!-- Patients Table -->
    <div class="bg-white p-4 rounded-lg shadow">
      <table class="w-full border">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 text-left">Full Name</th>
            <th class="px-4 py-2 text-left">Email</th>
            <th class="px-4 py-2 text-left">Phone</th>
            <th class="px-4 py-2 text-left">Service</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="patient in patients" :key="patient.id">
            <tr class="border-t">
              <td class="px-4 py-2" x-text="patient.full_name"></td>
              <td class="px-4 py-2" x-text="patient.email"></td>
              <td class="px-4 py-2" x-text="patient.phone"></td>
              <td class="px-4 py-2" x-text="patient.service"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Add Patient Modal -->
    <div x-show="showAddForm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h2 class="text-lg font-bold mb-4">Add New Patient</h2>
        
        <form @submit.prevent="addPatient">
          <div class="mb-3">
            <label class="block text-sm">Full Name</label>
            <input type="text" x-model="newPatient.full_name" class="w-full border p-2 rounded">
          </div>
          <div class="mb-3">
            <label class="block text-sm">Email</label>
            <input type="email" x-model="newPatient.email" class="w-full border p-2 rounded">
          </div>
          <div class="mb-3">
            <label class="block text-sm">Phone</label>
            <input type="text" x-model="newPatient.phone" class="w-full border p-2 rounded">
          </div>
          <div class="mb-3">
            <label class="block text-sm">Service</label>
            <input type="text" x-model="newPatient.service" class="w-full border p-2 rounded">
          </div>

          <div class="flex justify-end space-x-2">
            <button type="button" @click="showAddForm = false" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded">Submit</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Floating Add Button -->
    <div class="fixed bottom-4 right-4 z-50">
      <button @click="showAddForm = true" 
              class="px-4 py-3 bg-blue-500 text-white rounded-full shadow-lg">
        + Add Patient
      </button>
    </div>

  </div>

  <script>
    const supabaseUrl = "https://YOUR-PROJECT.supabase.co"; 
    const supabaseKey = "YOUR-ANON-KEY"; 
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    function patientsSection() {
      return {
        patients: [],
        showAddForm: false,
        newPatient: { full_name: "", email: "", phone: "", service: "" },

        async init() {
          await this.fetchPatients();

          // Real-time listener
          supabaseClient
            .channel("patients-changes")
            .on("postgres_changes", { event: "INSERT", schema: "public", table: "patients" }, (payload) => {
              this.patients.push(payload.new);
            })
            .subscribe();
        },

        async fetchPatients() {
          let { data, error } = await supabaseClient.from("patients").select("*");
          if (!error) {
            this.patients = data;
          }
        },

        async addPatient() {
          let { data, error } = await supabaseClient.from("patients").insert([this.newPatient]).select();
          if (!error && data.length > 0) {
            this.patients.push(data[0]); // fallback if realtime doesn't fire
          }
          this.newPatient = { full_name: "", email: "", phone: "", service: "" };
          this.showAddForm = false;
        }
      }
    }
  </script>
</body>
</html>
