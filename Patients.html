<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patients - Yanet Dental Clinic</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.34.0/dist/supabase.min.js"></script>
</head>
<body class="bg-gray-100">

<!-- Header -->
<header class="bg-white shadow p-3 flex items-center space-x-4 sticky top-0 z-50">
  <a href="index.html" class="text-gray-700 font-semibold hover:text-gray-900">‚Üê Dashboard</a>
  <h1 class="text-lg font-bold">Patients</h1>
</header>

<div class="max-w-4xl mx-auto pt-4 p-4">
  <div x-data="patientsSection()" x-init="init()" class="space-y-4">

    <!-- Search -->
    <div class="p-4">
      <input type="text" x-model="searchQuery" placeholder="Search patient..." 
             class="w-full p-2 border border-gray-300 rounded shadow-sm focus:outline-none focus:ring focus:border-blue-300">
    </div>

    <!-- Tabs -->
    <div class="flex space-x-4 border-b border-gray-200 overflow-x-auto">
      <button @click="activeTab='all'" :class="activeTab==='all' ? 'border-b-2 border-blue-500 font-semibold' : ''" class="py-2 px-4 flex-shrink-0">All</button>
      <button @click="activeTab='active'" :class="activeTab==='active' ? 'border-b-2 border-blue-500 font-semibold' : ''" class="py-2 px-4 flex-shrink-0">Active</button>
      <button @click="activeTab='inactive'" :class="activeTab==='inactive' ? 'border-b-2 border-blue-500 font-semibold' : ''" class="py-2 px-4 flex-shrink-0">Inactive</button>
    </div>

    <!-- Patients Table -->
    <div class="overflow-x-auto bg-white shadow rounded">
      <table class="min-w-full divide-y divide-gray-200 table-auto">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">ID</th>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Full Name</th>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Email</th>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Phone</th>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Service</th>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          <template x-for="patient in filteredPatients()" :key="patient.id">
            <tr>
              <td class="px-4 py-2 text-sm" x-text="patient.id"></td>
              <td class="px-4 py-2 text-sm" x-text="patient.full_name"></td>
              <td class="px-4 py-2 text-sm" x-text="patient.email"></td>
              <td class="px-4 py-2 text-sm" x-text="patient.phone"></td>
              <td class="px-4 py-2 text-sm" x-text="patient.service"></td>
              <td class="px-4 py-2 text-sm font-semibold" :class="{'text-green-600': patient.status==='active','text-gray-500': patient.status==='inactive'}" x-text="patient.status.toUpperCase()"></td>
              <td class="px-4 py-2 flex space-x-2 flex-wrap">
                <button @click="viewPatient(patient)" class="bg-blue-500 text-white px-3 py-2 rounded text-sm">View</button>
                <button @click="editPatient(patient)" class="bg-green-500 text-white px-3 py-2 rounded text-sm">Edit</button>
                <button @click="deletePatient(patient)" class="bg-red-500 text-white px-3 py-2 rounded text-sm">Delete</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Add Patient Modal -->
    <div 
      x-show="showAddForm" 
      x-transition:enter="transition ease-out duration-300" 
      x-transition:enter-start="opacity-0 scale-90" 
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition ease-in duration-200" 
      x-transition:leave-start="opacity-100 scale-100" 
      x-transition:leave-end="opacity-0 scale-90"
      class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50"
      @click.away="showAddForm=false"
    >
      <div class="bg-white rounded shadow-lg w-full max-w-md p-6 space-y-4">
        <h2 class="font-bold text-lg">Add New Patient</h2>
        <input type="text" x-model="newPatient.full_name" placeholder="Full Name" class="w-full border px-2 py-1 rounded"/>
        <input type="email" x-model="newPatient.email" placeholder="Email" class="w-full border px-2 py-1 rounded"/>
        <input type="text" x-model="newPatient.phone" placeholder="Phone" class="w-full border px-2 py-1 rounded"/>
        <input type="text" x-model="newPatient.service" placeholder="Service" class="w-full border px-2 py-1 rounded"/>
        <div class="flex justify-end space-x-2">
          <button @click="showAddForm=false" class="px-3 py-1 border rounded">Cancel</button>
          <button 
            @click="addPatient()" 
            :disabled="!newPatient.full_name || !newPatient.email || !newPatient.phone || !newPatient.service" 
            class="px-3 py-1 bg-blue-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
            Add
          </button>
        </div>
      </div>
    </div>

    <!-- View Patient Modal -->
    <div 
      x-show="showViewModal" 
      x-transition:enter="transition ease-out duration-300" 
      x-transition:enter-start="opacity-0 scale-90" 
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition ease-in duration-200" 
      x-transition:leave-start="opacity-100 scale-100" 
      x-transition:leave-end="opacity-0 scale-90"
      class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50"
      @click.away="showViewModal=false"
    >
      <div class="bg-white rounded shadow-lg w-full max-w-md p-6 space-y-4">
        <h2 class="font-bold text-lg">Patient Details</h2>
        <p><strong>Full Name:</strong> <span x-text="viewPatientData.full_name"></span></p>
        <p><strong>Email:</strong> <span x-text="viewPatientData.email"></span></p>
        <p><strong>Phone:</strong> <span x-text="viewPatientData.phone"></span></p>
        <p><strong>Service:</strong> <span x-text="viewPatientData.service"></span></p>
        <p><strong>Status:</strong> <span x-text="viewPatientData.status.toUpperCase()"></span></p>
        <div class="flex justify-end">
          <button @click="showViewModal=false" class="px-3 py-1 border rounded">Close</button>
        </div>
      </div>
    </div>

    <!-- Edit Patient Modal -->
    <div 
      x-show="showEditModal" 
      x-transition:enter="transition ease-out duration-300" 
      x-transition:enter-start="opacity-0 scale-90" 
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition ease-in duration-200" 
      x-transition:leave-start="opacity-100 scale-100" 
      x-transition:leave-end="opacity-0 scale-90"
      class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50"
      @click.away="showEditModal=false"
    >
      <div class="bg-white rounded shadow-lg w-full max-w-md p-6 space-y-4">
        <h2 class="font-bold text-lg">Edit Patient</h2>
        <input type="text" x-model="editPatientData.full_name" placeholder="Full Name" class="w-full border px-2 py-1 rounded"/>
        <input type="email" x-model="editPatientData.email" placeholder="Email" class="w-full border px-2 py-1 rounded"/>
        <input type="text" x-model="editPatientData.phone" placeholder="Phone" class="w-full border px-2 py-1 rounded"/>
        <input type="text" x-model="editPatientData.service" placeholder="Service" class="w-full border px-2 py-1 rounded"/>
        <select x-model="editPatientData.status" class="w-full border px-2 py-1 rounded">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
        <div class="flex justify-end space-x-2">
          <button @click="showEditModal=false" class="px-3 py-1 border rounded">Cancel</button>
          <button 
            @click="updatePatient()" 
            :disabled="!editPatientData.full_name || !editPatientData.email || !editPatientData.phone || !editPatientData.service" 
            class="px-3 py-1 bg-green-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
            Save
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Floating Add Button -->
<button @click="showAddForm=true" 
        class="fixed bottom-4 right-4 px-4 py-3 bg-blue-500 text-white rounded-full shadow-lg z-50">
  + Add Patient
</button>

<script>
const supabase = supabase.createClient('https://YOUR_PROJECT_URL.supabase.co', 'YOUR_ANON_KEY');

function patientsSection() {
  return {
    activeTab: 'all',
    patients: [],
    searchQuery: '',
    showAddForm: false,
    showViewModal: false,
    showEditModal: false,
    viewPatientData: {},
    editPatientData: {},
    newPatient: { full_name:'', email:'', phone:'', service:'', status:'active' },

    async init() {
      await this.fetchPatients();
      supabase.from('patients').on('INSERT', payload => {
        this.patients.unshift(payload.new);
      }).subscribe();
    },

    async fetchPatients() {
      const { data } = await supabase.from('patients').select('*');
      this.patients = data || [];
    },

    filteredPatients() {
      let filtered = this.patients;
      if(this.activeTab !== 'all') filtered = filtered.filter(p => p.status === this.activeTab);
      if(this.searchQuery) {
        const q = this.searchQuery.toLowerCase();
        filtered = filtered.filter(p =>
          p.full_name.toLowerCase().includes(q) ||
          p.email.toLowerCase().includes(q) ||
          p.phone.toLowerCase().includes(q) ||
          (p.service && p.service.toLowerCase().includes(q))
        );
      }
      return filtered;
    },

    viewPatient(patient) {
      this.viewPatientData = {...patient};
      this.showViewModal = true;
    },

    editPatient(patient) {
      this.editPatientData = {...patient};
      this.showEditModal = true;
    },

    async updatePatient() {
      const { data, error } = await supabase
        .from('patients')
        .update({
          full_name: this.editPatientData.full_name,
          email: this.editPatientData.email,
          phone: this.editPatientData.phone,
          service: this.editPatientData.service,
          status: this.editPatientData.status
        })
        .eq('id', this.editPatientData.id);
      if(error) return alert(error.message);
      const index = this.patients.findIndex(p => p.id === this.editPatientData.id);
      if(index !== -1) this.patients[index] = data[0];
      this.showEditModal = false;
    },

    deletePatient(patient) {
      if(confirm("Are you sure you want to delete this patient?")){
        supabase.from('patients').delete().eq('id', patient.id);
        this.patients = this.patients.filter(p => p.id !== patient.id);
      }
    },

    async addPatient() {
      if(!this.newPatient.full_name || !this.newPatient.email || !this.newPatient.phone || !this.newPatient.service)
        return alert("Please fill all fields");
      const { data, error } = await supabase.from('patients').insert([this.newPatient]);
      if(error) return alert(error.message);
      this.patients.unshift(data[0]);
      this.newPatient = { full_name:'', email:'', phone:'', service:'', status:'active' };
      this.showAddForm = false;
    }
  }
}
</script>

</body>
</html>
